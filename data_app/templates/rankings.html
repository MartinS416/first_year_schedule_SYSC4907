{% extends "base.html" %}
{% load static %}

{% block title %}Rankings{% endblock %}
{% block page_title %}Block Rankings{% endblock %}

{% block topbar_actions %}
<button class="btn btn-primary btn-sm" onclick="triggerRank('{% url 'api_rank_blocks' %}')">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="23 4 23 10 17 10"></polyline>
        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
    </svg>
    Re-rank All Blocks
</button>
{% endblock %}

{% block content %}

<!-- Summary Stats -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon stat-icon-primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ total_blocks }}</div>
            <div class="stat-label">Total Blocks</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon stat-icon-info">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ avg_score }}<span style="font-size: var(--text-sm); font-weight: 500; color: var(--gray-400);">/100</span></div>
            <div class="stat-label">Average Score</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon stat-icon-success">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ max_score }}<span style="font-size: var(--text-sm); font-weight: 500; color: var(--gray-400);">/100</span></div>
            <div class="stat-label">Highest Score</div>
        </div>
    </div>

    <div class="stat-card">
        <div class="stat-icon stat-icon-warning">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
                <polyline points="17 18 23 18 23 12"></polyline>
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-value">{{ min_score }}<span style="font-size: var(--text-sm); font-weight: 500; color: var(--gray-400);">/100</span></div>
            <div class="stat-label">Lowest Score</div>
        </div>
    </div>
</div>

<!-- Score Distribution -->
{% if total_blocks > 0 %}
<div class="card mb-6">
    <div class="card-header">
        <div>
            <h3 class="card-header-title">Score Distribution</h3>
            <p class="card-header-subtitle">Breakdown of block quality across all programs</p>
        </div>
    </div>
    <div class="card-body">
        <div style="display: flex; gap: var(--space-6); flex-wrap: wrap;">
            <!-- Excellent -->
            <div style="flex: 1; min-width: 150px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-2);">
                    <span class="text-sm text-bold" style="color: var(--success-700);">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        Excellent (85-100)
                    </span>
                    <span class="text-sm text-bold" style="color: var(--success-700);">{{ excellent_count }}</span>
                </div>
                <div class="progress">
                    <div class="progress-fill" style="width: {% widthratio excellent_count total_blocks 100 %}%; background: var(--success-500);"></div>
                </div>
            </div>

            <!-- Good -->
            <div style="flex: 1; min-width: 150px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-2);">
                    <span class="text-sm text-bold" style="color: var(--info-600);">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                            <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                        </svg>
                        Good (70-84)
                    </span>
                    <span class="text-sm text-bold" style="color: var(--info-600);">{{ good_count }}</span>
                </div>
                <div class="progress">
                    <div class="progress-fill" style="width: {% widthratio good_count total_blocks 100 %}%; background: var(--info-500);"></div>
                </div>
            </div>

            <!-- Fair -->
            <div style="flex: 1; min-width: 150px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-2);">
                    <span class="text-sm text-bold" style="color: var(--warning-700);">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        Fair (50-69)
                    </span>
                    <span class="text-sm text-bold" style="color: var(--warning-700);">{{ fair_count }}</span>
                </div>
                <div class="progress">
                    <div class="progress-fill" style="width: {% widthratio fair_count total_blocks 100 %}%; background: var(--warning-500);"></div>
                </div>
            </div>

            <!-- Poor -->
            <div style="flex: 1; min-width: 150px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-2);">
                    <span class="text-sm text-bold" style="color: var(--danger-700);">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        Poor (&lt;50)
                    </span>
                    <span class="text-sm text-bold" style="color: var(--danger-700);">{{ poor_count }}</span>
                </div>
                <div class="progress">
                    <div class="progress-fill" style="width: {% widthratio poor_count total_blocks 100 %}%; background: var(--danger-500);"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Rankings Table -->
<div class="section-header">
    <div>
        <h2 class="section-title">All Block Rankings</h2>
        <p class="section-subtitle">Blocks ranked by schedule quality score (higher is better)</p>
    </div>
    <div style="display: flex; align-items: center; gap: var(--space-3);">
        <label for="filter-program" class="text-xs text-muted" style="font-weight: 500;">Filter by program:</label>
        <select id="filter-program" class="btn btn-ghost btn-sm" style="padding-right: var(--space-6); appearance: auto; cursor: pointer;">
            <option value="all">All Programs</option>
            {% for prog in sidebar_programs %}
            <option value="{{ prog.program_name }}">{{ prog.program_name }}</option>
            {% endfor %}
        </select>
    </div>
</div>

{% if blocks_data %}
<div class="ranking-table-wrapper">
    <table class="ranking-table" id="rankings-table">
        <thead>
            <tr>
                <th style="width: 60px; text-align: center;">#</th>
                <th>Program</th>
                <th>Block</th>
                <th style="width: 80px; text-align: center;">Size</th>
                <th style="width: 240px;">Score</th>
            </tr>
        </thead>
        <tbody>
            {% for item in blocks_data %}
            <tr data-program="{{ item.program_name }}">
                <td style="text-align: center;">
                    <span class="text-sm text-muted" style="font-weight: 600; font-variant-numeric: tabular-nums;">{{ forloop.counter }}</span>
                </td>
                <td>
                    <a href="{% url 'program_detail' item.block.program.id %}" style="font-weight: 600; color: var(--gray-900); text-decoration: none;">
                        {{ item.program_name }}
                    </a>
                </td>
                <td>
                    <span class="text-sm" style="font-weight: 500; color: var(--gray-700);">{{ item.block.block_name }}</span>
                </td>
                <td style="text-align: center;">
                    <span class="pill pill-neutral">{{ item.block.size|default:"?" }}</span>
                </td>
                <td>
                    <div style="display: flex; align-items: center; gap: var(--space-3);">
                        <span class="ranking-score ranking-{{ item.ranking_class }}">{{ item.block.ranking|default:"0" }}</span>
                        <div class="score-bar score-{{ item.ranking_class }}">
                            <div class="score-bar-fill" style="width: {{ item.block.ranking|default:"0" }}%;"></div>
                        </div>
                        <span class="text-xs text-muted" style="min-width: 30px;">/100</span>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <div class="empty-state">
        <div class="empty-state-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
        </div>
        <h3 class="empty-state-title">No Rankings Available</h3>
        <p class="empty-state-text">
            Rankings will appear here once a schedule has been generated and blocks have been ranked. Generate a schedule first, then run the ranking process.
        </p>
        <a href="{% url 'generate' %}" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            Generate Schedule
        </a>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    var filterSelect = document.getElementById('filter-program');
    var table = document.getElementById('rankings-table');

    if (!filterSelect || !table) return;

    filterSelect.addEventListener('change', function() {
        var selected = filterSelect.value;
        var rows = table.querySelectorAll('tbody tr');
        var visibleIndex = 0;

        rows.forEach(function(row) {
            var programName = row.getAttribute('data-program');
            if (selected === 'all' || programName === selected) {
                row.style.display = '';
                visibleIndex++;
                // Update the row number
                var numCell = row.querySelector('td:first-child span');
                if (numCell) {
                    numCell.textContent = visibleIndex;
                }
            } else {
                row.style.display = 'none';
            }
        });
    });
})();
</script>
{% endblock %}
